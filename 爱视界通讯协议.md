- [概述](#概述)
  - [基本概念及技术选型](#基本概念及技术选型)
  - [节点消息总线](#节点消息总线)
- [机制](#机制)
  - [节点的自动发现](#节点的自动发现)
  - [消息总线的建立](#消息总线的建立)
- [节点类型](#节点类型)
  - [Main 类型](#main-类型)
  - [Pointer 类型](#pointer-类型)
  - [Sensor 类型](#sensor-类型)
  - [Peripheral 类型](#peripheral-类型)
- [频道类型](#频道类型)
  - [公共频道](#公共频道)
  - [私有频道](#私有频道)
  - [数据频道](#数据频道)
    - [EyeTracker 频道](#eyetracker-频道)
    - [InfraredCamera 频道](#infraredcamera-频道)
    - [WebCam 频道](#webcam-频道)
    - [HeartRateMonitor 频道](#heartratemonitor-频道)
    - [Switch 频道](#switch-频道)
- [消息格式定义](#消息格式定义)
  - [控制命令消息](#控制命令消息)
    - [TimeSync 命令的参数格式](#timesync-命令的参数格式)
  - [状态通知消息](#状态通知消息)
  - [节点属性同步消息](#节点属性同步消息)
  - [数据频道消息](#数据频道消息)
    - [EyeTracker 频道](#eyetracker-频道-1)
    - [Switch 频道](#switch-频道-1)

# 概述

## 基本概念及技术选型
爱视界系列软件的节点之间会自动组织成网络。网络中的每个节点都可能接收其他节点发送的消息，经过处理之后实现特定功能或者将处理结果转发给其他节点。

软件采用 ZeroMQ RFC 系列协议作为底层的消息传输协议，基于 Beacon 和 Pub/Sub 机制，实现节点间的自动发现与连接、稳定可靠的数据传输和节点故障的自动恢复。由于协议本身具有编程语言及平台中性，读者无论使用什么语言和开发工具，都应当可以根据本文档的描述及相关示例，编写出具有完整功能的第三方节点，与爱视界软件配合工作，实现各种强大的功能。

为方便节点的开发和管理，对节点作以下基本规定：
-   节点以可执行文件为组织单位。
-   爱视界软件主界面所对应的节点作为系统的核心，是网络中唯一的主节点 ( 节点类型为 Main ) 。
-   如果某个节点有采集并发送屏幕坐标信号 ( 来源可能是鼠标位置、眼控仪/头控仪信号、激光笔、脑机接口之类 ) 的功能，则称其为位置节点。这类节点在系统中也有比较独特的地位，下面会详述。
-   网络中既可能存在多个相同类型的节点，也可能一个节点承担多个类型的功能，但一般建议每个节点对应唯一的类型。
-   节点需要保证自己的进程在任何时候被终止并重启后，能够恢复正常工作。

## 节点消息总线
本通讯协议适用于系统中大部分或全部节点都运行在同一台计算机上，系统规模不大的情况，此时网络中所有节点能够自动发现彼此，形成一条消息总线。

节点从启动到正常开始传输数据的过程简介如下：
-   节点启动后会通过 Beacon 机制发现并加入到现有的消息总线。
-   和总线上其他节点进行属性同步，并从消息总线上订阅各自所需的数据频道。
-   开始数据接收/发送循环。

# 机制

## 节点的自动发现
软件采用 ZeroMQ RFC 36 协议描述的 Beacon 机制作为节点间自动发现的协议，详情可参考相关协议文档，这里不再赘述。

## 消息总线的建立
每个节点都需要创建一组符合 ZeroMQ RFC 23 协议的 Publisher 和 Subscriber，对应互连形成一条消息总线。详情可参考相关协议文档，这里不再赘述。

消息总线上的公共频道被定义为 Public 频道，所有的节点都需要订阅 Public 频道以共享部分消息。不同节点还会按需订阅不同的消息传输频道。

消息总线的具体建立过程如下：
-   节点启动后初始化其全局唯一 NodeId；初始化 Subscriber 并订阅 Public 频道和 NodeId 对应的频道 ( 用于属性同步 ) ；初始化 Publisher 并绑定随机端口；初始化 Beacon 并以每秒 1 次的频率广播其网络地址。
-   当 Beacon 消息表明有其他新节点出现时，应将 Subscriber 连接到这个新节点。
-   定期检测并清理那些一段时间内完全没有广播 Beacon 消息的死节点。

Beacon 广播的格式为：
```
ASJ/[协议版本号，当前为 1]
NodeId:初始化 Publisher 时绑定的端口号
```
上面每一条内容之间需要换行。本协议定义换行符为 `\r\n`。

在新节点加入消息总线时，会触发一次和总线上已有节点的属性同步操作。具体分为两步：
-   当新节点发现每个已有节点时，都会将节点自身属性作为一条消息向已有节点发送。
-   当每个已有节点发现新节点时，同样会向新节点发送一条包含节点自身属性的消息。

节点属性同步时所交换的消息中包含了节点的类型以及输入输出信号所使用的频道名。根据这些信息，节点间便可以建立起完整的通讯链路，开始正常工作了。

# 节点类型

## Main 类型
特指爱视界主程序。这是网络中唯一的主节点。其功能主要是接收其他节点传输的数据，并用于电脑的控制以及信息的展示。

## Pointer 类型
位置节点负责采集并发送屏幕坐标信号。其特殊性在于主节点会把第一个加入消息总线的位置节点作为主位置节点，并监测其工作状态。如果主位置节点停止工作或与消息总线断开连接，它会被主节点自动重启。
由于位置节点的特殊性，位置节点一般应当与主节点运行在同一台计算机上。

## Sensor 类型
传感器节点负责采集并发送例如心率、血压、呼吸率和环境温湿度等数据。

## Peripheral 类型
各种电脑外设皆属于此类型。

其实在广泛的定义下，Pointer 和 Sensor 都属于电脑外设，但是三者之间是有区别的，具体见下表：
|                      | Pointer | Sensor | Peripheral |
| -------------------- | ------- | ------ | ---------- |
| 工作状态是否会被监测 | √       | ×      | ×          |
| 是否参与系统控制过程 | √       | ×      | √          |

# 频道类型
Pub/Sub 模式要求节点收发消息时必须选择对应的一个或多个数据频道。频道按照类型不同可以分为三类：
1.  公共频道
2.  私有频道
3.  数据频道

公共频道和私有频道是消息总线上的每个节点都需要订阅的频道。除此之外，节点还应当确定收发数据使用的数据频道，并按需订阅这些频道用于收发数据。

每个节点都可以包含多个数据输入频道和数据输出频道，其名称只能从下文中列出的数据频道名称中选取。

只发送数据不接收数据的节点在发送时指明频道名称即可，不需要订阅任何数据频道，反之亦然。具体可以参考开发示例。

## 公共频道
公共频道名称为 Public。

## 私有频道
节点的私有频道名称即为其 NodeId，包含在消息头内用于节点之间发送点对点消息。虽然协议不会对 NodeId 的生成方式作明确定义，但要注意 NodeId 作为频道名称，不可与本节提到的任何公共或私有频道名称重复。建议使用 Guid 相关函数生成一组无意义字符作为 NodeId。

## 数据频道
一般来说每个不同的硬件设备类型都会对应一个单独的数据频道。

### EyeTracker 频道
眼控仪的坐标数据，隶属于 Pointer 类型节点。

### InfraredCamera 频道
红外摄像头的图像数据。有些眼控仪或者特殊的摄像头 ( 如 Kinect 或者 Intel RealSense ) 可以采集到红外图像。

### WebCam 频道
普通摄像头的图像数据。

### HeartRateMonitor 频道
心率检测装置的心率数据，隶属于 Sensor 类型节点。

### Switch 频道
外置按钮开关信号数据，隶属于 Peripheral 类型节点。

# 消息格式定义
为了方便消息处理，本协议规定节点之间互相传递的消息一律采用消息头加消息体的形式。

消息头格式如下：
```
ASJ/[协议版本号，当前为 1]
Id: 消息的全局唯一 id，可使用 Guid 相关函数来生成。
TimeStamp: 当前 UTC 时间，使用 ISO 8601 格式。如 2006-01-02T15:04:05.9999999Z。
NodeId: 消息发送方的 NodeId。
```
上面每一条内容之间需要换行。

消息体为 JSON 字符串。消息头和消息体之间必须有一个空行。

## 控制命令消息
控制命令类型的消息为节点向其他节点发送的控制命令，既可能存在于公共频道，也可能存在于私有频道。
| 字段         | 类型       | 说明                  |
| ------------ | ---------- | --------------------- |
| TargetNodeId | string     | 命令接收节点的 NodeId |
| Action       | string     | 命令名称              |
| Parameters   | JSON array | 参数                  |

软件运行过程中，主节点视情况可能会向每个节点的私有频道发送 TimeSync/Restart/Calibrate/SelfTest/Repair 共 5 种控制命令，分别对应时钟同步/重启设备/校准/自检/修复五类操作。每个节点需要按照收到的命令执行对应操作。

### TimeSync 命令的参数格式
时钟同步命令默认使用简单的时间戳同步协议，此时命令中会包含主节点时间戳。使用 NTP 和 IEEE1588 协议时命令中不会包含此参数，节点需要自行完成时钟同步操作。
| 字段      | 类型   | 说明     |
| --------- | ------ | -------- |
| Protocol  | string | 协议类型 |
| Timestamp | string | 时间戳   |

Restart/Calibrate/SelfTest/Repair 这 4 种控制命令不需要参数。

## 状态通知消息
状态通知类型的消息为节点状态改变的通知消息。

| 字段     | 类型   | 说明     |
| -------- | ------ | -------- |
| State    | string | 状态名称 |
| OldValue | string | 旧状态值 |
| NewValue | string | 新状态值 |

## 节点属性同步消息
节点属性同步消息必须含有如下字段：

| 字段      | 类型       | 说明         |
| --------- | ---------- | ------------ |
| NodeTypes | JSON array | 节点功能类型 |

其中节点功能类型并不唯一。

根据节点类型不同，节点属性同步消息还可以包含如下可选字段：

| 字段            | 类型       | 说明         |
| --------------- | ---------- | ------------ |
| NodePath        | string     | 节点路径     |
| SendChannels    | JSON array | 数据输出频道 |
| ReceiveChannels | JSON array | 数据输入频道 |

SendChannels 和 ReceiveChannels 都是 JSON 数组，数组中每个元素都需要包含如下字段：

| 字段    | 类型        | 说明         |
| ------- | ----------- | ------------ |
| Name    | string      | 数据频道名称 |
| Details | JSON object | 数据频道详情 |

对于名称为 EyeTracker 的数据频道，Details 应包含如下字段：

| 字段              | 类型   | 说明              |
| ----------------- | ------ | ----------------- |
| SerialNumber      | string | 序列号            |
| Model             | string | 型号              |
| Generation        | string | 平台              |
| FirmwareVersion   | string | 固件版本          |
| SamplingFrequency | float  | 采样率，单位为 Hz |

## 数据频道消息

### EyeTracker 频道
每个数据帧都可能是下面两种类型之一：

视线数据

| 字段 | 类型  | 说明                       |
| ---- | ----- | -------------------------- |
| x    | float | 屏幕 x 坐标                |
| y    | float | 屏幕 y 坐标                |
| pv   | float | 坐标可信度，取值范围为 0~1 |
| ts   | long  | 时间戳，单位为微秒         |

眼球位置数据

| 字段 | 类型  | 说明                           |
| ---- | ----- | ------------------------------ |
| lx   | float | 左眼 x 空间坐标                |
| ly   | float | 左眼 y 空间坐标                |
| lz   | float | 左眼 z 空间坐标                |
| lv   | float | 左眼坐标可信度，取值范围为 0~1 |
| rx   | float | 右眼 x 空间坐标                |
| ry   | float | 右眼 y 空间坐标                |
| rz   | float | 右眼 z 空间坐标                |
| rv   | float | 右眼坐标可信度，取值范围为 0~1 |
| ts   | long  | 时间戳，单位为微秒             |

### Switch 频道
节点发送的每个开关消息都必须含有如下字段：
| 字段  | 类型   | 说明                          |
| ----- | ------ | ----------------------------- |
| Key   | string | 开关的类型或键值              |
| State | string | 开关的状态，一般为 Up 或 Down |
