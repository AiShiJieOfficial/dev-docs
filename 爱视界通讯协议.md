# 概述

## 基本概念及技术选型
爱视界系列软件的节点之间会自动组织成网络，网络中的每个节点都可能接收其他节点发送的不同类型的消息，经过处理之后实现一定的功能或者将处理结果再转发给更多的节点。

软件采用ZeroMQ RFC系列协议作为底层的消息传输协议，基于Beacon和Pub/Sub机制，实现节点间的自动发现与连接、稳定可靠的数据传输和节点故障的自动恢复。由于协议本身具有编程语言及平台中性，读者无论使用什么开发环境，都应当可以根据本文档的描述及相关示例，编写出具有完整功能的第三方节点，与爱视界软件配合工作，以增强软件的功能。

为方便节点的开发和管理，对节点作以下基本规定：
- 节点以可执行文件为单位（每个exe文件对应一个节点）。
- 爱视界软件主界面所对应的节点作为系统的核心，是系统中唯一的主节点（节点类型为Main）。
- 如果某个节点的主要功能是采集并发送屏幕坐标信号（来源可能是鼠标位置、眼控仪/头控仪信号、激光笔之类），则称其为位置节点（节点类型为Pointer）。这类节点在系统中也有比较独特的地位，下面会详述。
- 节点需要保证自己的进程在任何时候被终止并重启后，能够恢复正常工作。

## 节点消息总线
本通讯协议适用于系统中大部分或全部节点都运行在同一台电脑上，系统规模不大的情况，此时网络中所有节点能够自动发现彼此，形成一条消息总线。

节点从启动到正常开始传输数据的过程简介如下：
- 节点启动后会通过Beacon机制发现并加入到现有的消息总线。
- 和总线上其他节点进行属性同步，并从消息总线上订阅各自所需的数据频道。
- 开始数据接收/发送循环。

# 机制

## 节点的自动发现
软件采用ZeroMQ RFC 36协议描述的Beacon机制作为节点间自动发现的协议，详情可参考相关文档，这里不再叙述。

## 消息总线的建立
每个节点都需要创建一组符合ZeroMQ RFC 23协议的Publisher和Subscriber，对应互连形成一条消息总线。消息总线上的公共频道被定义为Public频道，所有的节点都需要订阅Public频道以共享部分消息。不同节点还会按需订阅不同的消息传输频道。

消息总线的具体建立过程如下：
- 节点启动后初始化其全局唯一NodeId；初始化Subscriber并订阅Public频道和NodeId对应的频道（用于属性同步）；初始化Publisher并绑定随机端口；初始化Beacon并以每秒1次的频率广播其网络地址（格式为NodeId:Publisher的随机端口号）。
- 当Beacon消息表明有其他新节点出现时，应将Subscriber连接到这个新节点（接纳新节点加入消息总线），并将发现新节点的消息告知本节点的上层应用。
- 定期检测并移除那些一段时间内完全没有广播Beacon消息的死节点。并将移除死节点的消息告知本节点的上层应用。

在新节点加入消息总线时，会触发一次和总线上已有节点的属性同步操作。具体分为两步：
- 当新节点发现每个已有节点时，都会将节点自身属性作为一条消息向已有节点发送。
- 当每个已有节点发现新节点时，同样会向新节点发送一条包含节点自身属性的消息。

节点属性同步时所交换的消息中包含了节点的类型以及输入输出信号所使用的频道名。根据这些信息，节点间便可以建立起完整的通讯链路，开始正常工作了。

# 定义

## 节点类型定义

### Main
系统主节点。也就是爱视界主程序，软件会保证这是系统中唯一的主节点。

### Pointer
位置节点。主节点会把第一个加入消息总线的位置节点作为主位置节点，并检测其工作状态。如果主位置节点停止工作或与消息总线断开连接，它会被主节点自动重启。

### Sensor
传感器节点。例如心率、血压、呼吸率和环境温湿度等数据。

### Peripheral
外设类型节点。其实在更广泛的定义下，Pointer节点和Sensor节点都属于电脑外设，但Sensor节点一般只用于显示数据和提醒，不涉及控制电脑；Pointer节点可能会被主节点自动重启；而Peripheral节点往往作为用户控制电脑的辅助工具，而且不会被自动重启，所以这三者之间是有区别的。

## 频道类型和对应的消息格式定义
节点之间互相传递的消息一律采用Json格式。

### 公共频道
公共频道名称为Public。

#### Action消息
Action类型的消息为节点之间的控制命令。

|字段|类型|说明|
|-|-|-|
|Action|string|命令名称|
|Parameter|string|参数|
|SourceNodeId|string|命令发送节点的NodeId|
|TargetNodeId|string|命令接收节点的NodeId|

#### State消息
State类型的消息为节点状态改变的通知消息。

|字段|类型|说明|
|-|-|-|
|State|string|状态名称|
|OldValue|string|旧状态值|
|NewValue|string|新状态值|
|NodeId|string|节点的NodeId|

### 私有频道
节点的私有频道名称即为其NodeId，用于发送点对点消息。目前仅用于节点属性同步。

#### 节点属性同步消息
节点属性同步消息必须含有如下字段：

|字段|类型|说明|
|-|-|-|
|NodeType|string|节点类型|
|NodeId|string|节点Id|

虽然协议不会对NodeId的生成方式做明确定义，但NodeId作为频道名称，不可和本节中提到的其他任何频道重复。建议使用Guid相关函数生成一组无意义字符作为NodeId。

根据节点类型不同，节点属性同步消息还可以包含如下可选字段：

|字段|类型|说明|
|-|-|-|
|NodePath|string|节点路径|
|NodeInfo|json object|节点详细信息|
|NodeChannels|json object|节点数据频道|

对于EyeTracker类型的节点，NodeInfo应包含如下字段：

|字段|类型|说明|
|-|-|-|
|SerialNumber|string|序列号|
|Model|string|型号|
|Generation|string|平台|
|FirmwareVersion|string|固件版本|
|SamplingFrequency|float|采样率|

NodeChannels一般来说应当包含如下字段：

|字段|类型|说明|
|-|-|-|
|In|json array|数据输入频道|
|Out|json array|数据输出频道|

每个节点都可以包含多个数据输入频道和数据输出频道。其名称只能从本节中除公共频道和私有频道外的其他频道名中选取。节点连接到消息总线后，需要按需订阅其他节点的输出频道。例如主节点会试图订阅下面列出的所有频道种类。

### EyeTracker
眼控仪的坐标数据，隶属于Pointer类型节点。

每个数据帧分为两种类型：

视线数据

|字段|类型|说明|
|-|-|-|
|x|float|屏幕x坐标|
|y|float|屏幕y坐标|
|pv|float|坐标可信度|
|ts|long|时间戳|

眼球位置数据

|字段|类型|说明|
|-|-|-|
|lx|float|左眼x空间坐标|
|ly|float|左眼y空间坐标|
|lz|float|左眼z空间坐标|
|lv|float|左眼坐标可信度|
|rx|float|右眼x空间坐标|
|ry|float|右眼y空间坐标|
|rz|float|右眼z空间坐标|
|rv|float|右眼坐标可信度|
|ts|long|时间戳|

### InfraredCamera
红外摄像头的图像数据。有些眼控仪或者特殊的摄像头（如Kinect）可以采集到红外图像。

消息格式暂缺

### WebCam
普通摄像头的图像数据。

消息格式暂缺

### HeartRateMonitor
心率检测装置的心率数据，隶属于Sensor类型节点。

消息格式暂缺

### Switch
外置按钮开关信号数据，隶属于Peripheral类型节点。

消息格式暂缺

